# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Multitenancy —Å–∏—Å—Ç–µ–º—ã

## üéØ –ë–´–°–¢–†–´–ô –¢–ï–°–¢ (5 –º–∏–Ω—É—Ç):

### –¢–µ—Å—Ç 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫—É—Ä—å–µ—Ä–∞
```
1. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π Telegram –∞–∫–∫–∞—É–Ω—Ç (–∏–ª–∏ –ø–æ–ø—Ä–æ—Å–∏ –¥—Ä—É–≥–∞)
2. –û—Ç–ø—Ä–∞–≤—å –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É
3. –í–≤–µ–¥–∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥ (–∏–∑ .env —Ñ–∞–π–ª–∞)
4. –í—ã–±–µ—Ä–∏: "üì¶ –î–æ—Å—Ç–∞–≤–∫–∞" ‚Üí "üö¥ –ö—É—Ä—å–µ—Ä"
5. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –∫—É—Ä—å–µ—Ä
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏ –∫—É—Ä—å–µ—Ä–∞
```
–ö—É—Ä—å–µ—Ä –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã:

‚ùì "–ö–∞–∫–æ–π –∫–æ–¥ –æ—Ç —Å–∫–ª–∞–¥–∞?"
‚úÖ –û—Ç–≤–µ—Ç: "–∫–æ–¥ –æ—Ç —Å–∫–ª–∞–¥–∞ 1234" (–∏–∑ courier_guide.txt)

‚ùì "–ö–∞–∫–æ–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏?"
‚ùå –û—Ç–≤–µ—Ç: "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" (–∏–∑–æ–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!)

‚ùì "–ö–∞–∫–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏?"
‚úÖ –û—Ç–≤–µ—Ç: "support@uqsoft.com" (–∏–∑ common/welcome.txt)
```

### –¢–µ—Å—Ç 3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤—â–∏–∫–∞
```
1. –í—Ç–æ—Ä–æ–π –∞–∫–∫–∞—É–Ω—Ç
2. /start ‚Üí –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
3. –í—ã–±–µ—Ä–∏: "üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä"
4. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤—â–∏–∫
```

### –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤—â–∏–∫–∞
```
–°–æ—Ä—Ç–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã:

‚ùì "–ö–∞–∫–æ–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏?"
‚úÖ –û—Ç–≤–µ—Ç: "–∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ 5678" (–∏–∑ sorting_rules.txt)

‚ùì "–ö–∞–∫–æ–π –∫–æ–¥ –æ—Ç —Å–∫–ª–∞–¥–∞ –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤?"
‚ùå –û—Ç–≤–µ—Ç: "–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏" (–∏–∑–æ–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!)

‚ùì "–ö–∞–∫–æ–µ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è?"
‚úÖ –û—Ç–≤–µ—Ç: "9:00 - 18:00" (–∏–∑ common/welcome.txt)
```

---

## üìù –ü–†–û–í–ï–†–ö–ê –ß–ï–†–ï–ó –ë–î:

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ—Ç–¥–µ–ª–∞–º–∏
SELECT telegram_id, full_name, department, role 
FROM users;

-- –ù–∞–π—Ç–∏ –≤—Å–µ—Ö –∫—É—Ä—å–µ—Ä–æ–≤
SELECT * FROM users WHERE department = 'delivery/courier';

-- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –æ—Ç–¥–µ–ª–∞ (–∞–¥–º–∏–Ω—ã)
SELECT * FROM users WHERE department IS NULL;
```

---

## üîç –ü–†–û–í–ï–†–ö–ê –õ–û–ì–û–í:

### –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ª–æ–≥–∞—Ö:
```
[RAG] User 12345 department: delivery/courier
[RAG] Using department index: delivery/courier
[RAG] User 12345 (Dept: delivery/courier) searching for 3 most relevant chunks...
[RAG] Found 3 relevant chunks from 2 files: ['common/welcome.txt', 'delivery/courier/courier_guide.txt']
```

---

## üìä –ê–†–•–ò–¢–ï–ö–¢–£–†–ê:

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ø–∞–º—è—Ç–∏:
```python
GeminiService._vector_stores = {
    'delivery/courier': VectorStore(26 chunks),      # common + courier
    'delivery/franchise': VectorStore(25 chunks),    # —Ç–æ–ª—å–∫–æ common
    'sorting': VectorStore(26 chunks),               # common + sorting  
    'customer_service': VectorStore(25 chunks),      # —Ç–æ–ª—å–∫–æ common
}

GeminiService._vector_store = VectorStore(25 chunks)  # fallback –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
```

### –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞:
```python
user_department = await get_user_department(session, user_id)

if user_department:
    vector_store = GeminiService._vector_stores[user_department]
    # –ü–æ–∏—Å–∫ –¢–û–õ–¨–ö–û –≤ –∏–Ω–¥–µ–∫—Å–µ –æ—Ç–¥–µ–ª–∞
else:
    vector_store = GeminiService._vector_store
    # –ê–¥–º–∏–Ω - fallback –∏–Ω–¥–µ–∫—Å (common)
```

---

## üé® –î–û–ë–ê–í–õ–ï–ù–ò–ï –ù–û–í–´–• –ó–ù–ê–ù–ò–ô:

### –î–ª—è –∫—É—Ä—å–µ—Ä–æ–≤:
```bash
# –°–æ–∑–¥–∞–π —Ñ–∞–π–ª
echo "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –≤ –¥–æ–∂–¥—å" > "data/knowledge/delivery/courier/rain_delivery.txt"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞ (–∏–Ω–¥–µ–∫—Å—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
# –¢–æ–ª—å–∫–æ –∫—É—Ä—å–µ—Ä—ã —É–≤–∏–¥—è—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª!
```

### –î–ª—è –≤—Å–µ—Ö –æ—Ç–¥–µ–ª–æ–≤ (common):
```bash
# –°–æ–∑–¥–∞–π —Ñ–∞–π–ª
echo "–ù–æ–≤–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –æ—Ç–ø—É—Å–∫–æ–≤" > "data/knowledge/common/vacation_policy.txt"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
# –í–°–ï –æ—Ç–¥–µ–ª—ã —É–≤–∏–¥—è—Ç —ç—Ç–æ—Ç —Ñ–∞–π–ª!
```

---

## ‚öôÔ∏è –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø:

### –û—Ç–¥–µ–ª—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ `app/core/models.py`:
```python
class Department(str, Enum):
    COURIER = "delivery/courier"
    FRANCHISE = "delivery/franchise"
    SORTING = "sorting"
    CUSTOMER_SERVICE = "customer_service"
```

### –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –æ—Ç–¥–µ–ª:
```python
# 1. –í models.py:
class Department(str, Enum):
    ...
    WAREHOUSE = "warehouse"  # –ù–æ–≤—ã–π –æ—Ç–¥–µ–ª
    
    @classmethod
    def get_display_names(cls):
        return {
            ...
            cls.WAREHOUSE: "–°–∫–ª–∞–¥",  # –ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è UI
        }

# 2. –°–æ–∑–¥–∞–π –ø–∞–ø–∫—É:
mkdir data/knowledge/warehouse

# 3. –î–æ–±–∞–≤—å –≤ keyboards/department.py –∫–Ω–æ–ø–∫—É

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞
```

---

## üö® –£–°–¢–†–ê–ù–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú:

### –ü—Ä–æ–±–ª–µ–º–∞: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —á—É–∂–∏–µ –∑–Ω–∞–Ω–∏—è"
```
–ü—Ä–∏—á–∏–Ω–∞: department –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ë–î
–†–µ—à–µ–Ω–∏–µ: 
  UPDATE users SET department = 'delivery/courier' WHERE telegram_id = 12345;
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–ò–Ω–¥–µ–∫—Å—ã –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è"
```
–ü—Ä–∏—á–∏–Ω–∞: –ü—É—Å—Ç—ã–µ –ø–∞–ø–∫–∏ –æ—Ç–¥–µ–ª–æ–≤
–†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É –æ—Ç–¥–µ–ª–∞
```

### –ü—Ä–æ–±–ª–µ–º–∞: "–ê–¥–º–∏–Ω –Ω–µ –≤–∏–¥–∏—Ç –∑–Ω–∞–Ω–∏—è"
```
–ü—Ä–∏—á–∏–Ω–∞: department = NULL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç fallback –∏–Ω–¥–µ–∫—Å (—Ç–æ–ª—å–∫–æ common)
–†–µ—à–µ–Ω–∏–µ: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ê–¥–º–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å common —Ñ–∞–π–ª–∞–º–∏.
```

---

## üìà –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê:

‚úÖ **4 –æ—Ç–¥–µ–ª–∞** —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∏–Ω–¥–µ–∫—Å–∞–º–∏
‚úÖ **25 common chunks** –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º
‚úÖ **–°–µ–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞** –º–µ–∂–¥—É –æ—Ç–¥–µ–ª–∞–º–∏
‚úÖ **–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω** –±–µ–∑ –æ—à–∏–±–æ–∫
‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–¥–µ–ª–∞** —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ–∏—Å–∫–∞** —á–µ—Ä–µ–∑ FAISS —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞

---

## üéâ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ö PRODUCTION!

**–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—à–∏–±–∫–∏:** $0 (–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!)
**–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:** 45 –º–∏–Ω—É—Ç
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** 90% (–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
