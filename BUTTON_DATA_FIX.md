# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ BUTTON_DATA_INVALID

## –ü—Ä–æ–±–ª–µ–º–∞
Telegram API –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä `callback_data` –¥–æ **64 –±–∞–π—Ç**. –ü—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–∞–º–∏, –∏–º–µ—é—â–∏–º–∏ –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø–∞–ø–∫–µ "sorting"), –±–æ—Ç –ø–∞–¥–∞–ª —Å –æ—à–∏–±–∫–æ–π `BUTTON_DATA_INVALID`.

–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ callback_data:
```
kb_file:sorting:–ü—Ä–∏–Ω—è—Ç–∏–µ_—Ç–æ–≤–∞—Ä–∞_–∏_–ø—Ä–æ–≤–µ—Ä–∫–∞_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏_–ø–æ_–ø–æ—Å—Ç–∞–≤–∫–∞–º.pdf
```
–î–ª–∏–Ω–∞: ~70 –±–∞–π—Ç ‚Üí –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç.

## –†–µ—à–µ–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ **—Ö–µ—à-–º–∞–ø–ø–∏–Ω–≥–∞**:

### 1. –•–µ—à-—Ñ—É–Ω–∫—Ü–∏–∏ (—Å—Ç—Ä–æ–∫–∏ 30-53)
```python
_file_hash_map: Dict[str, Tuple[str, str]] = {}

def generate_file_hash(dept_name: str, filename: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π MD5 —Ö–µ—à (10 —Å–∏–º–≤–æ–ª–æ–≤)."""
    full_path = f"{dept_name}:{filename}"
    return hashlib.md5(full_path.encode()).hexdigest()[:10]

def register_file_hash(dept_name: str, filename: str) -> str:
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª –≤ –º–∞–ø–ø–∏–Ω–≥–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ö–µ—à."""
    file_hash = generate_file_hash(dept_name, filename)
    _file_hash_map[file_hash] = (dept_name, filename)
    return file_hash

def get_file_by_hash(file_hash: str) -> Tuple[str, str] | None:
    """–ü–æ–ª—É—á–∞–µ—Ç (dept_name, filename) –ø–æ —Ö–µ—à—É."""
    return _file_hash_map.get(file_hash)
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã

#### `handle_kb_department_callback` (—Å—Ç—Ä–æ–∫–∞ 1390)
- –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª –≤ –º–∞–ø–ø–∏–Ω–≥–µ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–≥–æ –∏–º–µ–Ω–∏:
  ```python
  file_hash = register_file_hash(dept_name, filename)
  callback_data=f"kb_file:{file_hash}"  # –ë—ã–ª–æ: kb_file:sorting:long_name.pdf
  ```
- –û–±—Ä–µ–∑–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –≤–∏–∑—É–∞–ª—å–Ω–æ: `filename[:27] + "..."`

#### `handle_kb_file_callback` (—Å—Ç—Ä–æ–∫–∞ 1500)
- –ü–∞—Ä—Å–∏—Ç `file_hash` –∏–∑ callback_data
- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—É—Ç—å —á–µ—Ä–µ–∑ `get_file_by_hash()`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ö–µ—à–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–∫–∞—á–∞—Ç—å" –∏ "–£–¥–∞–ª–∏—Ç—å"

#### `handle_kb_download_callback` (—Å—Ç—Ä–æ–∫–∞ 1582)
- –ü–æ–ª—É—á–∞–µ—Ç `dept_name` –∏ `filename` –ø–æ —Ö–µ—à—É
- –°–∫–∞—á–∏–≤–∞–µ—Ç —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç–µ–º

#### `handle_kb_delete_callback` (—Å—Ç—Ä–æ–∫–∞ 1657)
- –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –ø–æ —Ö–µ—à—É
- –û—á–∏—â–∞–µ—Ç –∑–∞–ø–∏—Å—å –∏–∑ `_file_hash_map` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

### 3. Legacy-—Ñ—É–Ω–∫—Ü–∏–∏
–°—Ç–∞—Ä—ã–π –∫–æ–¥ (—Ñ—É–Ω–∫—Ü–∏—è `create_knowledge_files_keyboard`) —Ç–æ–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `dept_name="legacy"` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –û–±—Ä–µ–∑–∞–µ—Ç –¥–ª–∏–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤

## –ü—Ä–∏–º–µ—Ä—ã callback_data

**–î–æ:**
```
kb_file:sorting:–ü—Ä–∏–Ω—è—Ç–∏–µ_—Ç–æ–≤–∞—Ä–∞_–∏_–ø—Ä–æ–≤–µ—Ä–∫–∞_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏_–ø–æ_–ø–æ—Å—Ç–∞–≤–∫–∞–º.pdf  ‚ùå (>64 –±–∞–π—Ç)
kb_download:sorting:–ü—Ä–∏–Ω—è—Ç–∏–µ_—Ç–æ–≤–∞—Ä–∞_–∏_–ø—Ä–æ–≤–µ—Ä–∫–∞_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏_–ø–æ_–ø–æ—Å—Ç–∞–≤–∫–∞–º.pdf  ‚ùå
kb_del:sorting:–ü—Ä–∏–Ω—è—Ç–∏–µ_—Ç–æ–≤–∞—Ä–∞_–∏_–ø—Ä–æ–≤–µ—Ä–∫–∞_–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏_–ø–æ_–ø–æ—Å—Ç–∞–≤–∫–∞–º.pdf  ‚ùå
```

**–ü–æ—Å–ª–µ:**
```
kb_file:a3f7c8e921  ‚úÖ (~17 –±–∞–π—Ç)
kb_download:a3f7c8e921  ‚úÖ
kb_del:a3f7c8e921  ‚úÖ
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
1. **–ì–∞—Ä–∞–Ω—Ç–∏—è**: –•–µ—à –≤—Å–µ–≥–¥–∞ 10 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí callback_data –≤—Å–µ–≥–¥–∞ < 64 –±–∞–π—Ç
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ó–∞—â–∏—Ç–∞ –æ—Ç path traversal —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: HashMap lookup O(1)
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç —Å –∏–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª–æ–≤ –ª—é–±–æ–π –¥–ª–∏–Ω—ã
5. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: Legacy-–∫–æ–¥ —Ç–æ–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –°–µ–π—á–∞—Å –º–∞–ø–ø–∏–Ω–≥ –≤ –ø–∞–º—è—Ç–∏ (`_file_hash_map`). –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –æ–Ω –æ—á–∏—â–∞–µ—Ç—Å—è, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ö–µ—à–∏ —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–∞–ø–∫–∏.
- **–ö–æ–ª–ª–∏–∑–∏–∏**: MD5 –Ω–∞ 10 —Å–∏–º–≤–æ–ª–∞—Ö —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏, –Ω–æ –¥–ª—è —Å–æ—Ç–µ–Ω —Ñ–∞–π–ª–æ–≤ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞–π–Ω–µ –º–∞–ª–∞.
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –î–ª—è production –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –≤ SQLite –∏–ª–∏ Redis.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
1. –û—Ç–∫—Ä—ã—Ç—å "üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π"
2. –í—ã–±—Ä–∞—Ç—å "üìÇ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞"
3. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
4. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª —Å –¥–ª–∏–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å" –∏ "–£–¥–∞–ª–∏—Ç—å"
