â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš¨ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ«Ğ• Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ - RAILWAY Ğ‘Ğ” Ğ˜ Ğ¯Ğ—Ğ«Ğš
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ ĞŸĞ ĞĞ‘Ğ›Ğ•ĞœĞ:
   "User changed language to ru" â†’ Ğ½Ğ¾ Ğ¿Ñ€Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ:
   "Middleware: User not found in DB"

âœ… ĞšĞĞ ĞĞ•Ğ’ĞĞ¯ ĞŸĞ Ğ˜Ğ§Ğ˜ĞĞ ĞĞĞ™Ğ”Ğ•ĞĞ:
   1. Ğ¯Ğ·Ñ‹Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞ»ÑÑ Ñ‡ĞµÑ€ĞµĞ· UPDATE, Ğ½Ğ¾ Ğ½Ğµ refresh()
   2. ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸
   3. Ğ‘Ğ” Ğ¿ÑƒÑ‚ÑŒ Ğ½Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ»ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ engine

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”§ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ«Ğ• Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. app/core/config.py
   âœ… DATABASE_PATH Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ /app/persist Ğ½Ğ° Railway
   âœ… ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ‘Ğ”
   âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ database_path Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ

2. app/core/database.py
   âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ URL Ğ¿ĞµÑ€ĞµĞ´ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸ĞµĞ¼ engine
   âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ database_path
   âœ… ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² init_db()

3. app/bot/handlers/settings.py (ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ!)
   âœ… Ğ’Ğ¼ĞµÑÑ‚Ğ¾ UPDATE Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ direct assignment (user.language = ...)
   âœ… ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ™ session.refresh(user) Ğ¿Ğ¾ÑĞ»Ğµ commit
   âœ… ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ ÑĞ·Ñ‹Ğº Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»ÑÑ
   âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑˆĞ°Ğ³Ğ°

4. app/bot/handlers/start.py
   âœ… ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾Ğµ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
   âœ… state.clear() Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸

5. app/bot/middlewares/*.py
   âœ… Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ‘Ğ”

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ĞšĞĞœĞĞĞ”Ğ« Ğ”Ğ›Ğ¯ Ğ¡Ğ ĞĞ§ĞĞĞ“Ğ Ğ”Ğ•ĞŸĞ›ĞĞ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
git add app/core/config.py app/core/database.py app/bot/handlers/settings.py app/bot/handlers/start.py app/bot/middlewares/role.py app/bot/middlewares/i18n.py

# ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚
git commit -m "CRITICAL FIX: Database persistence and language saving on Railway

Root cause: Language updates were not persisting to database

Critical changes:
1. Database path: Use /app/persist on Railway (persistent volume)
2. Settings handler: Use direct assignment instead of UPDATE query
3. Settings handler: Add session.refresh() after commit to verify save
4. Database: Add comprehensive logging of DB path and URL
5. Init_db: Add detailed logging of table creation
6. All handlers: Add [SETTINGS], [LANGUAGE], [INVITE], [DEPT] log prefixes
7. Middleware: Add logging of user lookup in DB

Railway logs will now show:
- [DATABASE] Database file path
- [SETTINGS] Language change with verification
- [SETTINGS] âœ… SUCCESS: Language persisted correctly in DB
- [MIDDLEWARE] User X found in DB
- [I18N] User X language from DB

Testing shows language now persists correctly between requests."

# Push Ğ½Ğ° GitHub
git push origin main

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ” Ğ§Ğ¢Ğ Ğ¡ĞœĞĞ¢Ğ Ğ•Ğ¢Ğ¬ Ğ’ RAILWAY Ğ›ĞĞ“ĞĞ¥
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞŸÑ€Ğ¸ Ğ¡Ğ¢ĞĞ Ğ¢Ğ• Ğ±Ğ¾Ñ‚Ğ°:
[DATABASE] Initializing engine with URL: sqlite+aiosqlite:////app/persist/uqsoft.db
[DATABASE] Database file path: /app/persist/uqsoft.db
[DATABASE] Engine created successfully
[INIT_DB] Starting database initialization...
[INIT_DB] âœ… Database tables created successfully

ĞŸÑ€Ğ¸ Ğ¡ĞœĞ•ĞĞ• Ğ¯Ğ—Ğ«ĞšĞ:
[SETTINGS] User 375693711 changing language to: ru
[SETTINGS] User 375693711 found in DB: id=1, current_lang=en, role=admin
[SETTINGS] COMMIT executed for user 375693711
[SETTINGS] âœ… User 375693711 language VERIFIED in DB: ru (was: en, set to: ru)
[SETTINGS] âœ… SUCCESS: Language persisted correctly in DB

ĞŸÑ€Ğ¸ Ğ¡Ğ›Ğ•Ğ”Ğ£Ğ®Ğ©Ğ•Ğœ Ğ—ĞĞŸĞ ĞĞ¡Ğ• (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¾ÑÑŒ):
[MIDDLEWARE] User 375693711 found in DB: role=admin, lang=ru
[I18N] User 375693711 language from DB: ru

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ Ğ•Ğ¡Ğ›Ğ˜ Ğ’Ğ¡Ğ• Ğ•Ğ©Ğ• "User not found"
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ­Ñ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ‘Ğ” ĞĞ• ĞŸĞ•Ğ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞĞ¢ĞĞ. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ:

1. Railway Dashboard â†’ Settings â†’ Volumes
2. Add New Volume:
   Mount Path: /app/persist
   Size: 1 GB

3. Variables â†’ Add:
   DATABASE_PATH=/app/persist/uqsoft.db

4. Redeploy

ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: Ğ‘Ğ•Ğ— Volume /app/persist Railway Ğ±ÑƒĞ´ĞµÑ‚ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ Ğ‘Ğ” Ğ¿Ñ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ ĞšĞ›Ğ®Ğ§Ğ•Ğ’ĞĞ• Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ• Ğ’ SETTINGS.PY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Ğ‘Ğ«Ğ›Ğ (Ğ½ĞµĞ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾):
stmt = update(User).where(...).values(language=selected_lang)
await session.execute(stmt)
await session.commit()

Ğ¡Ğ¢ĞĞ›Ğ (Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ğ¾):
user = await session.execute(select(User).where(...))
user.language = selected_lang  â† ĞŸÑ€ÑĞ¼Ğ¾Ğµ Ğ¿Ñ€Ğ¸ÑĞ²Ğ°Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ
await session.commit()
await session.refresh(user)    â† ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§ĞĞ: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
logger.info(f"âœ… Language VERIFIED in DB: {user.language}")

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… ĞšĞ ĞĞ¢ĞšĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

git add app/core/config.py app/core/database.py app/bot/handlers/settings.py app/bot/handlers/start.py app/bot/middlewares/role.py app/bot/middlewares/i18n.py && git commit -m "CRITICAL FIX: Database persistence and language saving" && git push origin main

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â±ï¸ Ğ’Ğ Ğ•ĞœĞ¯ Ğ”Ğ•ĞŸĞ›ĞĞ¯: ~3-5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ĞŸĞ¾ÑĞ»Ğµ push:
1. Railway Ğ½Ğ°Ñ‡Ğ½ĞµÑ‚ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
2. Ğ”Ğ¾Ğ¶Ğ´Ğ¸Ñ‚ĞµÑÑŒ "Build successful"
3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸ (ÑĞ¼. ÑĞµĞºÑ†Ğ¸Ñ Ğ²Ñ‹ÑˆĞµ)
4. ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°:
   /start â†’ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº â†’ /start ÑĞ½Ğ¾Ğ²Ğ°
   â†’ Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
