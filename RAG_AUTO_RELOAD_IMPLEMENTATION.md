# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ RAG –∏–Ω–¥–µ–∫—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π) –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∏—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –ò–Ω–¥–µ–∫—Å—ã RAG –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∏–∑-–∑–∞ —á–µ–≥–æ –ø–æ—è–≤–ª—è–ª–æ—Å—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:
```
WARNING: "[RAG] Department Department.SORTING not found in indices, using fallback"
```

–ù–∞ –ª–æ–∫–∞–ª–∫–µ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ –∏–¥–µ–∞–ª—å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –∏–Ω–¥–µ–∫—Å—ã –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ. –ù–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∏ –∏–Ω–¥–µ–∫—Å—ã –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–º–∏.

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `reload_indices()` –≤ `GeminiService`

**–§–∞–π–ª:** `app/services/ai_service.py`

```python
@staticmethod
async def reload_indices() -> None:
    """
    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–µ–π).
    """
    logger.info("[RAG] üîÑ Reloading all indices...")
    GeminiService._vector_stores = {}
    GeminiService._vector_store = None
    GeminiService._create_department_indices()
    logger.info("[RAG] ‚úÖ Indices reloaded successfully")
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `/reload` –¥–ª—è —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏

**–§–∞–π–ª:** `app/bot/handlers/admin.py`

–ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã RAG:

```python
@router.message(Command("reload"))
async def cmd_reload_indices(message: Message) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ RAG –∏–Ω–¥–µ–∫—Å–æ–≤."""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if not await check_admin_access(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return
    
    await message.answer("üîÑ –ù–∞—á–∏–Ω–∞—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤ RAG...")
    await GeminiService.reload_indices()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats_text = f"‚úÖ –ò–Ω–¥–µ–∫—Å—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã!\n\n"
    stats_text += f"üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –æ—Ç–¥–µ–ª–æ–≤: {len(GeminiService._vector_stores)}\n"
    # ... –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –æ—Ç–¥–µ–ª–∞–º
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω –º–µ—Ç–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

**–§–∞–π–ª:** `app/bot/handlers/admin.py`, —Ñ—É–Ω–∫—Ü–∏—è `handle_delete_file`

–ó–∞–º–µ–Ω–µ–Ω –≤—ã–∑–æ–≤ `_create_department_indices()` –Ω–∞ –Ω–æ–≤—ã–π `reload_indices()`:

```python
try:
    logger.info("[RAG] Reloading indices after file deletion...")
    await GeminiService.reload_indices()
    logger.info("[RAG] Indices reloaded successfully")
except Exception as e:
    logger.error(f"[RAG] Error reloading indices: {e}", exc_info=True)
```

### 4. –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ** –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –º–µ—Å—Ç–∞—Ö:

#### a) –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
**–§–∞–π–ª:** `app/bot/handlers/admin_dept_handler.py`

–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:
- `GeminiService.rebuild_index_for_department(department)` - –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞
- `GeminiService._create_department_indices()` - –µ—Å–ª–∏ —Ñ–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ `common/` (–æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –æ—Ç–¥–µ–ª—ã)

#### b) –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é
**–§–∞–π–ª:** `app/services/ai_service.py`, –º–µ—Ç–æ–¥ `delete_document`

–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `rebuild_index_for_department(dept_name)` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –æ—Ç–¥–µ–ª–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –∞–¥–º–∏–Ω–∫–∏ **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è** –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏–ª–∏ –ø—É—à–∞ –Ω–∞ –≥–∏—Ç:

1. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –æ—Ç–¥–µ–ª–∞
2. ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞** ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –æ—Ç–¥–µ–ª–∞
3. ‚úÖ **–†—É—á–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞** ‚Üí –∫–æ–º–∞–Ω–¥–∞ `/reload` –¥–ª—è –∞–¥–º–∏–Ω–æ–≤

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ—á–µ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –∏–Ω–¥–µ–∫—Å–æ–≤:
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –≤ –æ—Ç–¥–µ–ª –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ –æ—Ç–¥–µ–ª–∞
- –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –≤ `common/` –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã (—Ç.–∫. common —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –æ—Ç–¥–µ–ª–∞–º)

–≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ **–±—ã—Å—Ç—Ä–µ–µ** —á–µ–º –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –∑–∞–¥–µ—Ä–∂–µ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
1. –ê–¥–º–∏–Ω –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ "üìù –î–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞–Ω–∏–µ" –∏–ª–∏ "üì• –î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª"
2. –í—ã–±–∏—Ä–∞–µ—Ç –æ—Ç–¥–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `sorting`)
3. –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∏–Ω–¥–µ–∫—Å –æ—Ç–¥–µ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–¥–µ–ª–∞ —Å—Ä–∞–∑—É –≤–∏–¥—è—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –æ—Ç–≤–µ—Ç–∞—Ö

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
1. –ê–¥–º–∏–Ω —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ "üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π"
2. –ò–Ω–¥–µ–∫—Å –æ—Ç–¥–µ–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
3. –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –±–æ–ª—å—à–µ –Ω–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –†—É—á–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
1. –ê–¥–º–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—É `/reload`
2. –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
3. –ë–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –æ—Ç–¥–µ–ª–∞–º

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `[RAG]`:

```
[RAG] üîÑ Reloading all indices...
[RAG] Creating department-based vector indices...
[RAG] Creating index for department: sorting
[RAG] Index created for sorting: 45 chunks
[RAG] ‚úÖ Indices reloaded successfully
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ª–æ–≥–∞—Ö –±–æ—Ç–∞.
