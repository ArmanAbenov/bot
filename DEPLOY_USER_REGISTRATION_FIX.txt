# ===================================================================
# üö® –°–†–û–ß–ù–´–ô –î–ï–ü–õ–û–ô: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
# ===================================================================
# –ü—Ä–æ–±–ª–µ–º–∞: "User NOT found in DB! Cannot change language."
# –†–µ—à–µ–Ω–∏–µ: –°–æ–∑–¥–∞–µ–º user –≤ –ë–î –°–†–ê–ó–£ –ø—Ä–∏ /start (—Å language=None)
# ===================================================================

# 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
git status

# 2Ô∏è‚É£ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
git add app/bot/handlers/start.py app/utils/department.py CRITICAL_FIX_USER_REGISTRATION.md DEPLOY_USER_REGISTRATION_FIX.txt

# 3Ô∏è‚É£ –ö–æ–º–º–∏—Ç
git commit -m "CRITICAL FIX: Create user in DB immediately on /start

- User is now created in DB on /start with language=None and department=None
- Language selection handler updates existing user instead of creating new one
- Invite code handler verifies user exists without creating duplicate
- Department selection uses direct assignment + session.refresh() for verification
- Added extensive [START], [LANGUAGE], [INVITE], [DEPT] logging for Railway
- Fixes 'User NOT found in DB! Cannot change language' error"

# 4Ô∏è‚É£ Push –Ω–∞ Railway (–∞–≤—Ç–æ–¥–µ–ø–ª–æ–π)
git push origin main

# ===================================================================
# ‚è±Ô∏è –í—Ä–µ–º—è –¥–µ–ø–ª–æ—è: ~2-3 –º–∏–Ω—É—Ç—ã
# üìä –û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –ø–æ—Å–ª–µ /start:
#
# [START] New user {telegram_id} - creating in DB immediately
# [START] ‚úÖ User {telegram_id} CREATED in DB: id=1, role=employee, language=None
# [START] Database path: /app/persist/uqsoft.db
# [START] Language selection shown to user {telegram_id}
#
# –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞:
# [LANGUAGE] ‚úÖ User {telegram_id} language VERIFIED in DB: ru
# [LANGUAGE] ‚úÖ SUCCESS: Language persisted correctly in DB
#
# –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Ç–¥–µ–ª–∞:
# [DEPT] ‚úÖ User {telegram_id} department VERIFIED in DB: sorting
# [DEPT] ‚úÖ SUCCESS: Department persisted correctly in DB
# ===================================================================

# üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ Railway:
railway logs --follow

# –ò–ª–∏ –≤ Railway Dashboard:
# Deployments -> Latest -> View logs

# ===================================================================
# ‚úÖ –ü—Ä–∏–∑–Ω–∞–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:
# 1. –í –ª–æ–≥–∞—Ö Railway –µ—Å—Ç—å [START] ‚úÖ User CREATED in DB
# 2. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞ –µ—Å—Ç—å [LANGUAGE] ‚úÖ SUCCESS: Language persisted correctly
# 3. Middleware –±–æ–ª—å—à–µ –ù–ï –ø–∏—à–µ—Ç "User not found in DB"
# 4. –ë–æ—Ç –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —è–∑—ã–∫ –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º /start
# ===================================================================
