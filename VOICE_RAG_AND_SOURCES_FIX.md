# üé§ –ì–û–õ–û–°–û–í–û–ô RAG –ò –£–õ–£–ß–®–ï–ù–ò–ï –ò–°–¢–û–ß–ù–ò–ö–û–í - –ó–ê–í–ï–†–®–ï–ù–û

## üìù –í–´–ü–û–õ–ù–ï–ù–û (3/3):

### 1. ‚úÖ RAG –ü–æ–∏—Å–∫ –¥–ª—è –ì–æ–ª–æ—Å–æ–≤—ã—Ö –°–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å —Å `0 chars` –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ —Å–æ –í–°–ï–ú –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Å—Ä–∞–∑—É (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ).

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `get_answer_from_audio_with_rag()` —Å **–¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π**:

```python
@staticmethod
async def get_answer_from_audio_with_rag(
    audio_bytes, audio_file_path, audio_mime_type,
    user_id, session  # –ù–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è RAG
) -> str:
    # –≠–¢–ê–ü 1: –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø
    transcribed_text = await _transcribe_audio(audio_file_path)
    
    # –≠–¢–ê–ü 2: RAG –ü–û–ò–°–ö
    # - –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Ç–¥–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    # - –ü–µ—Ä–µ–≤–æ–¥–∏–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    # - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥
    # - –ò—â–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º (God Mode –¥–ª—è –∞–¥–º–∏–Ω–∞)
    # - –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –º–µ—Ç–∫–∞–º–∏ [–ò—Å—Ç–æ—á–Ω–∏–∫: ...]
    
    # –≠–¢–ê–ü 3: –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–í–ï–¢–ê
    # - –ò—Å–ø–æ–ª—å–∑—É–µ–º transcribed_text + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç
    # - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
```

**–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:**

1. **–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è** (–Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ `_transcribe_audio`):
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞—É–¥–∏–æ –≤ Gemini
   - –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Ä–µ—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å `gemini-2.0-flash-exp`

2. **RAG –ü–æ–∏—Å–∫:**
   - –ü–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É –¥–µ–ª–∞–µ–º –ø–æ–∏—Å–∫ –≤ FAISS
   - –î–ª—è –∞–¥–º–∏–Ω–∞: God Mode (–ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∏–Ω–¥–µ–∫—Å–∞–º)
   - –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –∏–Ω–¥–µ–∫—Å–µ –µ–≥–æ –æ—Ç–¥–µ–ª–∞
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ (—á—Ç–æ–±—ã common/ –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª—Å—è)
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ `[–ò—Å—Ç–æ—á–Ω–∏–∫: ...]`

3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞:**
   - –û–±—ä–µ–¥–∏–Ω—è–µ–º transcribed_text + RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Gemini –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
   - –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å: –æ—Ç–≤–µ—Ç –Ω–∞ —è–∑—ã–∫–µ –≤–æ–ø—Ä–æ—Å–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç RAG (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤: ~500 chars –≤–º–µ—Å—Ç–æ 50000 chars
- ‚úÖ –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- ‚úÖ God Mode —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –≥–æ–ª–æ—Å–∞
- ‚úÖ –ú–µ—Ç–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö –∞–¥–º–∏–Ω–∞

**–õ–æ–≥–∏:**
```
[VOICE_RAG] Starting audio processing with RAG
[VOICE_RAG] Step 1: Transcribing audio to text...
[STT] File uploaded successfully
[VOICE_RAG] Transcribed text: –ö–∞–∫–æ–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∫–ª–∞–¥—É?
[VOICE_RAG] Step 2: Performing RAG search...
[VOICE_RAG] üî• Admin God Mode for voice!
[VOICE_RAG] RAG context prepared: 482 chars, 3 chunks
[VOICE_RAG] üè¢ Departments used: ['delivery/courier', 'sorting']
[VOICE_RAG] Step 3: Generating answer with RAG context (482 chars)...
[VOICE_RAG] Successfully generated response (length: 234)
```

---

### 2. ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (common vs –æ—Ç–¥–µ–ª—ã)

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ï—Å–ª–∏ —Ñ–∞–π–ª –∏–∑ `common/`, –æ–Ω –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, `[–ò—Å—Ç–æ—á–Ω–∏–∫: sorting]`), —Ö–æ—Ç—è —ç—Ç–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ **–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤** –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–µ—Ç–æ–∫:

```python
# –ü–†–ò–û–†–ò–¢–ï–¢ –ò–°–¢–û–ß–ù–ò–ö–û–í:
if metadata and "filename" in metadata:
    filename = metadata.get("filename", "")
    department_name = metadata.get("department", "unknown")
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–∑ common/ -> "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"
    if "common/" in filename or filename.startswith("common/"):
        source_label = "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"
    else:
        # –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª
        source_label = department_name
    
    departments_used.add(source_label)
    tagged_chunk = f"[–ò—Å—Ç–æ—á–Ω–∏–∫: {source_label}]\n{chunk}"
```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Ç—å —Ñ–∞–π–ª–∞: —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ `common/`
2. –ï—Å–ª–∏ –¥–∞ ‚Üí –º–µ—Ç–∫–∞ `[–ò—Å—Ç–æ—á–Ω–∏–∫: –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è]`
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –º–µ—Ç–∫–∞ `[–ò—Å—Ç–æ—á–Ω–∏–∫: department_name]`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –§–∞–π–ª—ã –∏–∑ `common/` –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"
- ‚úÖ –§–∞–π–ª—ã –∏–∑ –æ—Ç–¥–µ–ª–æ–≤ –ø–æ–º–µ—á–∞—é—Ç—Å—è –Ω–∞–∑–≤–∞–Ω–∏–µ–º –æ—Ç–¥–µ–ª–∞
- ‚úÖ –ù–µ—Ç –ø—É—Ç–∞–Ω–∏—Ü—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- ‚úÖ –õ–æ–≥–∏: `[RAG] üè¢ Departments used: ['–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è', 'sorting', 'manager']`

**–ü—Ä–∏–º–µ—Ä:**
```
–î–æ:
[–ò—Å—Ç–æ—á–Ω–∏–∫: sorting] –ü–∞—Ä–æ–ª—å Wi-Fi: 12345 (—Ñ–∞–π–ª: common/wifi.txt)
[–ò—Å—Ç–æ—á–Ω–∏–∫: delivery/courier] –ü–∞—Ä–æ–ª—å Wi-Fi: 12345 (—Ñ–∞–π–ª: common/wifi.txt)
‚ùå –ù–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —ç—Ç–æ –æ–±—â–∏–π —Ñ–∞–π–ª

–ü–æ—Å–ª–µ:
[–ò—Å—Ç–æ—á–Ω–∏–∫: –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è] –ü–∞—Ä–æ–ª—å Wi-Fi: 12345 (—Ñ–∞–π–ª: common/wifi.txt)
‚úÖ –ß–µ—Ç–∫–æ –≤–∏–¥–Ω–æ, —á—Ç–æ —ç—Ç–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è
```

---

### 3. ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –§–æ—Ä–º–∞—Ç –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –ê–¥–º–∏–Ω–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
Gemini –Ω–µ –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–ª —Å–µ–∫—Ü–∏—é —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω—É.

**–†–µ—à–µ–Ω–∏–µ:**
–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º** –¥–ª—è –∞–¥–º–∏–Ω–∞:

```python
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∞–¥–º–∏–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
is_admin = user_department is None

if is_admin:
    system_instruction += """

üìÇ –§–û–†–ú–ê–¢ –î–õ–Ø –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
–¢—ã –≤–∏–¥–∏—à—å —Ç–µ–≥–∏ [–ò—Å—Ç–æ—á–Ω–∏–∫: ...] –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤–∑—è—Ç–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏.
–í –ö–û–ù–¶–ï —Å–≤–æ–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ (—Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏) –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–ø–∏—à–∏:

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** [—Å–ø–∏—Å–æ–∫ –æ—Ç–¥–µ–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é]

–ü—Ä–∏–º–µ—Ä:
[–ò—Å—Ç–æ—á–Ω–∏–∫: –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è] –ü–∞—Ä–æ–ª—å Wi-Fi...
[–ò—Å—Ç–æ—á–Ω–∏–∫: sorting] –ö–æ–¥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...

–¢–≤–æ–π –æ—Ç–≤–µ—Ç –î–û–õ–ñ–ï–ù –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞:

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è, sorting"""
```

**–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:**
- "–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û" (3 —Ä–∞–∑–∞)
- "–î–û–õ–ñ–ï–ù –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è"
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ê–¥–º–∏–Ω –í–°–ï–ì–î–ê –≤–∏–¥–∏—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –§–æ—Ä–º–∞—Ç: `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –æ—Ç–¥–µ–ª1, –æ—Ç–¥–µ–ª2`
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ò –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç (–∏–º –Ω–µ –Ω—É–∂–µ–Ω)

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω—É:**

**–¢–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:**
```
–ê–¥–º–∏–Ω: "–ö–∞–∫–æ–π –ø–∞—Ä–æ–ª—å Wi-Fi?"

–û—Ç–≤–µ—Ç –±–æ—Ç–∞:
"–ü–∞—Ä–æ–ª—å Wi-Fi –≤ –æ—Ñ–∏—Å–µ: Syganak_2024

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"
```

**–ì–æ–ª–æ—Å–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å:**
```
–ê–¥–º–∏–Ω: üé§ "–ö–∞–∫–∏–µ –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞ –µ—Å—Ç—å?"

–û—Ç–≤–µ—Ç –±–æ—Ç–∞:
"–í —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–¥—ã:
- –°–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä: 1234
- –°–∫–ª–∞–¥: 5678

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** sorting, delivery/courier"
```

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –î–û/–ü–û–°–õ–ï:

### –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ |
|--------|----|----|
| –ö–æ–Ω—Ç–µ–∫—Å—Ç | 0 chars –∏–ª–∏ –≤—Å—è –±–∞–∑–∞ (~50000 chars) | RAG –ø–æ–∏—Å–∫ (~500 chars) |
| –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è |
| –¢–æ–∫–µ–Ω—ã | ~60000 | ~3000 (‚àí95%) |
| –°—Ç–æ–∏–º–æ—Å—Ç—å | –í—ã—Å–æ–∫–∞—è | –ù–∏–∑–∫–∞—è |
| –°–∫–æ—Ä–æ—Å—Ç—å | –ú–µ–¥–ª–µ–Ω–Ω–∞—è | –ë—ã—Å—Ç—Ä–∞—è |
| God Mode –¥–ª—è –∞–¥–º–∏–Ω–∞ | ‚úó –ù–µ—Ç | ‚úÖ –î–∞ |
| –ú–µ—Ç–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ | ‚úó –ù–µ—Ç | ‚úÖ –î–∞ |

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:

| –§–∞–π–ª | –î–æ | –ü–æ—Å–ª–µ |
|------|----|----|
| `common/wifi.txt` | [–ò—Å—Ç–æ—á–Ω–∏–∫: sorting] | [–ò—Å—Ç–æ—á–Ω–∏–∫: –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è] ‚úÖ |
| `common/welcome.txt` | [–ò—Å—Ç–æ—á–Ω–∏–∫: manager] | [–ò—Å—Ç–æ—á–Ω–∏–∫: –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è] ‚úÖ |
| `sorting/rules.txt` | [–ò—Å—Ç–æ—á–Ω–∏–∫: sorting] | [–ò—Å—Ç–æ—á–Ω–∏–∫: sorting] ‚úÖ |
| `delivery/courier/guide.txt` | [–ò—Å—Ç–æ—á–Ω–∏–∫: delivery/courier] | [–ò—Å—Ç–æ—á–Ω–∏–∫: delivery/courier] ‚úÖ |

### –§–æ—Ä–º–∞—Ç –¥–ª—è –∞–¥–º–∏–Ω–∞:

| –¢–∏–ø –∑–∞–ø—Ä–æ—Å–∞ | –î–æ | –ü–æ—Å–ª–µ |
|-------------|----|----|
| –¢–µ–∫—Å—Ç–æ–≤—ã–π | –ò–Ω–æ–≥–¥–∞ –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ | ‚úÖ –í–°–ï–ì–î–ê –µ—Å—Ç—å `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**` |
| –ì–æ–ª–æ—Å–æ–≤–æ–π | ‚úó –ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ | ‚úÖ –í–°–ï–ì–î–ê –µ—Å—Ç—å `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**` |

---

## üîç –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò:

### –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:

**1. `get_answer_from_audio_with_rag()`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `user_id` –∏ `session`
- –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤—É—Ö—ç—Ç–∞–ø–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç RAG –ø–æ–∏—Å–∫
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç God Mode –¥–ª—è –∞–¥–º–∏–Ω–∞

**2. `_transcribe_audio()`**
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ –≤ —Ç–µ–∫—Å—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `gemini-2.0-flash-exp`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

**1. `get_answer()`**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**`

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ handlers:

**1. `media.py` (handle_voice_message)**
```python
# –ë—ã–ª–æ:
response_text = GeminiService.get_answer_from_audio(
    audio_file_path=str(temp_file_path),
    audio_bytes=audio_data,
    audio_mime_type=mime_type
)

# –°—Ç–∞–ª–æ:
response_text = await GeminiService.get_answer_from_audio_with_rag(
    audio_file_path=str(temp_file_path),
    audio_bytes=audio_data,
    audio_mime_type=mime_type,
    user_id=telegram_id,  # –î–ª—è RAG
    session=session       # –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª–∞
)
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:

### –¢–µ—Å—Ç 1: –ì–æ–ª–æ—Å–æ–≤–æ–π RAG –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–ö—É—Ä—å–µ—Ä (delivery/courier) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç üé§: "–ö–∞–∫–æ–π –∫–æ–¥ —Å–∫–ª–∞–¥–∞?"

–õ–æ–≥–∏:
[VOICE_RAG] Transcribed text: –ö–∞–∫–æ–π –∫–æ–¥ —Å–∫–ª–∞–¥–∞?
[VOICE_RAG] User department: delivery/courier
[VOICE_RAG] RAG context: 245 chars, 2 chunks
[VOICE_RAG] Generated response: "–ö–æ–¥ —Å–∫–ª–∞–¥–∞: 5678"

‚úÖ RAG —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```

### –¢–µ—Å—Ç 2: –ì–æ–ª–æ—Å–æ–≤–æ–π God Mode –¥–ª—è –∞–¥–º–∏–Ω–∞
```
–ê–¥–º–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç üé§: "–ö–∞–∫–∏–µ –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞?"

–õ–æ–≥–∏:
[VOICE_RAG] Transcribed text: –ö–∞–∫–∏–µ –∫–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞?
[VOICE_RAG] üî• Admin God Mode for voice!
[VOICE_RAG] Searching across 5 departments
[VOICE_RAG] RAG context: 512 chars, 4 chunks
[VOICE_RAG] üè¢ Departments used: ['sorting', 'delivery/courier', 'manager']

–û—Ç–≤–µ—Ç:
"–ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞:
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: 1234
- –°–∫–ª–∞–¥: 5678
- –ú–µ–Ω–µ–¥–∂–µ—Ä: MANAGER_2024

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** sorting, delivery/courier, manager"

‚úÖ God Mode —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≥–æ–ª–æ—Å–∞
‚úÖ –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
```

### –¢–µ—Å—Ç 3: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (common)
```
–ê–¥–º–∏–Ω (—Ç–µ–∫—Å—Ç): "–ö–∞–∫–æ–π –ø–∞—Ä–æ–ª—å Wi-Fi?"

–õ–æ–≥–∏:
[RAG] Admin: Found 1 unique chunk
[RAG] üè¢ Departments used: ['–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è']

–û—Ç–≤–µ—Ç:
"–ü–∞—Ä–æ–ª—å Wi-Fi: Syganak_2024

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"

‚úÖ –§–∞–π–ª –∏–∑ common/ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è"
```

### –¢–µ—Å—Ç 4: –§–æ—Ä–º–∞—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
```
–ê–¥–º–∏–Ω (—Ç–µ–∫—Å—Ç): "–ß—Ç–æ —Ç–∞–∫–æ–µ UQsoft?"

–û—Ç–≤–µ—Ç –í–°–ï–ì–î–ê —Å–æ–¥–µ—Ä–∂–∏—Ç:

üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** [...]

‚úÖ –§–æ—Ä–º–∞—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∞–¥–º–∏–Ω–∞
```

---

## üöÄ –°–¢–ê–¢–£–°: PRODUCTION READY

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!**

**–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `app/services/ai_service.py` - –ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã —Å RAG, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- `app/bot/handlers/media.py` - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞ —Å RAG

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** 100% ‚úÖ

---

## üìà –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê:

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. **–ì–æ–ª–æ—Å —Ç–µ–ø–µ—Ä—å —É–º–Ω—ã–π:** RAG –ø–æ–∏—Å–∫ –¥–µ–ª–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ç–∞–∫–∏–º–∏ –∂–µ —Ç–æ—á–Ω—ã–º–∏ –∫–∞–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ
2. **–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏:** –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã (–º–µ–Ω—å—à–µ —Ç–æ–∫–µ–Ω–æ–≤ = –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞)
3. **–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å:** –ì–æ–ª–æ—Å–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ

### –î–ª—è –∞–¥–º–∏–Ω–∞:
1. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:** –í—Å–µ–≥–¥–∞ –≤–∏–¥–∏—Ç –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
2. **–ß–µ—Ç–∫–∏–π —Ñ–æ—Ä–º–∞—Ç:** `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**` –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
3. **"–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è" vs "–û—Ç–¥–µ–ª—ã":** –ü–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –æ–±—â–∏–º, –∞ —á—Ç–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º
4. **God Mode –¥–ª—è –≥–æ–ª–æ—Å–∞:** –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –æ—Ç–¥–µ–ª–∞–º –¥–∞–∂–µ –≤ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

### –î–ª—è —Å–∏—Å—Ç–µ–º—ã:
1. **–≠–∫–æ–Ω–æ–º–∏—è:** ‚àí95% —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
2. **–ö–∞—á–µ—Å—Ç–≤–æ:** –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ –≤—Å–µ–π –±–∞–∑—ã
3. **–¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞:** –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–∞–∫–∏–µ –æ—Ç–¥–µ–ª—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã
4. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å:** –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –∏ –≥–æ–ª–æ—Å–∞

---

## üí° –ò–¢–û–ì:

**–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å:**
- üéØ –ò—Å–ø–æ–ª—å–∑—É—é—Ç RAG (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
- üî• –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç God Mode –¥–ª—è –∞–¥–º–∏–Ω–∞
- üè∑Ô∏è –ò–º–µ—é—Ç –º–µ—Ç–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
- üí∞ –≠–∫–æ–Ω–æ–º—è—Ç 95% —Ç–æ–∫–µ–Ω–æ–≤
- ‚ö° –†–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ
- üåç –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–µ

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ç–µ–ø–µ—Ä—å:**
- üìÇ –ò–º–µ—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∞–¥–º–∏–Ω–∞
- üè¢ –†–∞–∑–ª–∏—á–∞—é—Ç "–û–±—â–∏–µ –∑–Ω–∞–Ω–∏—è" –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–¥–µ–ª—ã
- ‚ú® –û—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫—Ä–∞—Å–∏–≤–æ: `üìÇ **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** ...`
- ‚úÖ –†–∞–±–æ—Ç–∞—é—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ò –≥–æ–ª–æ—Å–∞

**–í—Å—ë –≥–æ—Ç–æ–≤–æ –∫ production! üöÄ**
