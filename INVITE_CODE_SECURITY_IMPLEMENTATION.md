# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤ (Security Gate)

## –û–±–∑–æ—Ä

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ —É–ª—É—á—à–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É —á–µ—Ä–µ–∑ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã. –¢–µ–ø–µ—Ä—å –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –±–µ–∑ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞.

## –ü—Ä–æ–±–ª–µ–º–∞

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- –ë–æ—Ç —Å—Ä–∞–∑—É –ø—É—Å–∫–∞–ª –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Å–∏—Å—Ç–µ–º—É
- –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
- –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- –õ—é–±–æ–π –º–æ–≥ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- –ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –†–∏—Å–∫ —É—Ç–µ—á–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

## –†–µ—à–µ–Ω–∏–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ is_verified –≤ –º–æ–¥–µ–ª—å User

**–§–∞–π–ª:** `app/core/models.py`

```python
class User(Base):
    # ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è ...
    
    is_verified: Mapped[bool] = mapped_column(
        Boolean, default=False, nullable=False
    )  # –ü—Ä–æ—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∫—É –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞
```

**–ó–Ω–∞—á–µ–Ω–∏—è:**
- `False` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É)
- `True` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)

### 2. –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞

**–§–∞–π–ª:** `app/utils/states.py`

```python
class RegistrationState(StatesGroup):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    
    waiting_for_invite_code = State()  # ‚úÖ –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    waiting_for_language = State()
    waiting_for_department = State()
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω —Ö–µ–Ω–¥–ª–µ—Ä /start

**–§–∞–π–ª:** `app/bot/handlers/start.py`

#### –õ–æ–≥–∏–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ê–¥–º–∏–Ω**
```python
if user is None and user_is_admin:
    # –°–æ–∑–¥–∞–µ–º –∞–¥–º–∏–Ω–∞ —Å—Ä–∞–∑—É —Å is_verified=True
    user = User(
        telegram_id=telegram_id,
        full_name=full_name,
        role="admin",
        department=None,
        is_verified=True,  # ‚úÖ –ê–¥–º–∏–Ω—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    )
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —è–∑—ã–∫–∞
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –û–±—ã—á–Ω—ã–π**
```python
if user is None and not user_is_admin:
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
    await state.set_state(RegistrationState.waiting_for_invite_code)
    await message.answer("üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥...")
    return  # –ù–µ –ø—É—Å–∫–∞–µ–º –¥–∞–ª—å—à–µ!
```

#### –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω**
```python
if user and not user.is_verified:
    if user_is_admin:
        # –ê–¥–º–∏–Ω - –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        user.is_verified = True
        await session.commit()
    else:
        # –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥
        await state.set_state(RegistrationState.waiting_for_invite_code)
        await message.answer("üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥...")
        return
```

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω**
```python
if user and user.is_verified:
    # –ü—É—Å–∫–∞–µ–º –≤ —Å–∏—Å—Ç–µ–º—É - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```

### 4. –°–æ–∑–¥–∞–Ω —Ö–µ–Ω–¥–ª–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞

**–§–∞–π–ª:** `app/bot/handlers/start.py`

```python
@router.message(StateFilter(RegistrationState.waiting_for_invite_code))
async def handle_invite_code_input(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞ –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    
    invite_code = message.text.strip()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
    if invite_code != settings.invite_code:
        # –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥
        await message.answer("‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return
    
    # –í–µ—Ä–Ω—ã–π –∫–æ–¥ - —Å–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(
        telegram_id=telegram_id,
        full_name=full_name,
        role="employee",
        department="common",
        is_verified=True,  # ‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω!
    )
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É —è–∑—ã–∫–∞
    await state.set_state(RegistrationState.waiting_for_language)
    await message.answer("‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫...")
```

**–ò–Ω–≤–∞–π—Ç-–∫–æ–¥:**
- –•—Ä–∞–Ω–∏—Ç—Å—è –≤ `settings.invite_code` (–∏–∑ `.env` –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç "UQ2026")
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (case-sensitive)
- –ü—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –∫–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è

### 5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –≤ middleware

**–§–∞–π–ª:** `app/bot/middlewares/role.py`

```python
# –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –±–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
if user_exists and not is_verified:
    # –†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö:
    # - /start –∫–æ–º–∞–Ω–¥–∞
    # - Callback –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
    # - –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ RegistrationState)
    
    is_start_command = event.text and event.text.startswith("/start")
    is_lang_callback = event.data and event.data.startswith("lang_")
    is_in_registration_flow = "RegistrationState" in current_state
    
    if not (is_start_command or is_lang_callback or is_in_registration_flow):
        # –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø
        await event.answer("‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (/start)")
        return  # –•–µ–Ω–¥–ª–µ—Ä –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è!
```

**–ó–∞—â–∏—â–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
- ‚ùå –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- ‚ùå –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- ‚ùå –ù–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚ùå –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚ùå –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–†–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
- ‚úÖ /start –∫–æ–º–∞–Ω–¥–∞
- ‚úÖ –í–≤–æ–¥ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞
- ‚úÖ –í—ã–±–æ—Ä —è–∑—ã–∫–∞
- ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### 6. –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π

**–§–∞–π–ª:** `app/core/migrations.py`

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `is_verified` –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ë–î:

```python
async def migrate_add_is_verified(session: AsyncSession) -> bool:
    """–î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ is_verified –≤ —Ç–∞–±–ª–∏—Ü—É users."""
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏
    exists = await check_column_exists(session, "users", "is_verified")
    
    if exists:
        return True  # –£–∂–µ –µ—Å—Ç—å
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É
    await session.execute(text(
        "ALTER TABLE users ADD COLUMN is_verified BOOLEAN NOT NULL DEFAULT 0"
    ))
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
    await session.execute(text(
        "UPDATE users SET is_verified = 1"
    ))
    
    await session.commit()
    return True
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª–µ `is_verified`
- –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ—Ç —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º `False`
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö (–æ–Ω–∏ —É–∂–µ –≤ —Å–∏—Å—Ç–µ–º–µ)
- –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### 7. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –≤ init_db

**–§–∞–π–ª:** `app/core/database.py`

```python
async def init_db() -> None:
    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã
    await conn.run_sync(Base.metadata.create_all)
    
    # ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
    from app.core.migrations import run_migrations
    async with AsyncSessionLocal() as session:
        await run_migrations(session)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
    # ...
```

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π)
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∞
4. –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ

## –ü–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–û–±—ã—á–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫)

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start
2. –ë–æ—Ç ‚Üí "üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "UQ2026"
4. –ë–æ—Ç ‚Üí "‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫"
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –†—É—Å—Å–∫–∏–π
6. –ë–æ—Ç ‚Üí "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª" (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –°–æ—Ä—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä
8. –ë–æ—Ç ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ‚úÖ
```

### –ù–æ–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

```
1. –ê–¥–º–∏–Ω ‚Üí /start
2. –ë–æ—Ç ‚Üí "‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫"
   (–∏–Ω–≤–∞–π—Ç-–∫–æ–¥ –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è)
3. –ê–¥–º–∏–Ω ‚Üí –†—É—Å—Å–∫–∏–π
4. –ë–æ—Ç ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é ‚úÖ
```

### –ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–≤–∞–π—Ç-–∫–æ–¥

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí /start
2. –ë–æ—Ç ‚Üí "üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "wrong_code"
4. –ë–æ—Ç ‚Üí "‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"
   (–æ—Å—Ç–∞–µ—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–¥–∞)
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "UQ2026"
6. –ë–æ—Ç ‚Üí "‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫"
```

### –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

```
1. –ù–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "–°–ø—Ä–æ—Å–∏ –±–∞–∑—É"
2. Middleware ‚Üí –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
3. –ë–æ—Ç ‚Üí "‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (/start)"
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞

1. **–ù–∞ —É—Ä–æ–≤–Ω–µ –ë–î:**
   - –ü–æ–ª–µ `is_verified` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
   - –î–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: `False`

2. **–ù–∞ —É—Ä–æ–≤–Ω–µ —Ö–µ–Ω–¥–ª–µ—Ä–∞ /start:**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é
   - –ó–∞–ø—Ä–æ—Å –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞ —É –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö

3. **–ù–∞ —É—Ä–æ–≤–Ω–µ middleware:**
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
   - –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

4. **–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ù–µ —Ç—Ä–µ–±—É—é—Ç –∏–Ω–≤–∞–π—Ç-–∫–æ–¥

### –ò–Ω–≤–∞–π—Ç-–∫–æ–¥

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```env
# .env —Ñ–∞–π–ª
INVITE_CODE=UQ2026
```

**–°–≤–æ–π—Å—Ç–≤–∞:**
- –ï–¥–∏–Ω—ã–π –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Case-sensitive (—Ä–µ–≥–∏—Å—Ç—Ä –≤–∞–∂–µ–Ω)
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω –≤ `.env`

**–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞:**
1. –ê–¥–º–∏–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "üîë –ò–Ω–≤–∞–π—Ç-–∫–æ–¥" –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
2. –í–∏–¥–∏—Ç —Ç–µ–∫—É—â–∏–π –∫–æ–¥: `UQ2026`
3. –î–µ–ª–∏—Ç—Å—è –∫–æ–¥–æ–º —Å –Ω–æ–≤—ã–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ö–æ–¥–∞

**–ß—Ç–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è middleware:**
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "üîç –°–ø—Ä–æ—Å–∏ –±–∞–∑—É" –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚ùå –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚ùå –õ—é–±—ã–µ callback –±–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ß—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ:**
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ /start
- ‚úÖ –í–≤–æ–¥ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞
- ‚úÖ –í—ã–±–æ—Ä —è–∑—ã–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è)

## –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

**–§–∞–π–ª:** `app/core/migrations.py`

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—è `is_verified`**
   ```sql
   PRAGMA table_info(users)
   ```

2. **–ï—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è:**
   ```sql
   ALTER TABLE users ADD COLUMN is_verified BOOLEAN NOT NULL DEFAULT 0
   ```

3. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è:**
   ```sql
   UPDATE users SET is_verified = 1
   ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç –∏–Ω–≤–∞–π—Ç-–∫–æ–¥
- –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

### –†—É—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**SQL —Å–∫—Ä–∏–ø—Ç:** `migrations/add_is_verified_field.sql`

–ú–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

```bash
sqlite3 data/uqsoft.db < migrations/add_is_verified_field.sql
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:

### [START] - –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```
[START] New user 123456 - requesting invite code
[START] User 123456 is admin - auto-verifying
[START] ‚úÖ Admin 123456 created with is_verified=True
```

### [INVITE] - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞

```
[INVITE] User 123456 entered invite code: UQ2026
[INVITE] ‚úÖ Correct invite code for user 123456
[INVITE] ‚ùå Wrong invite code for user 789: 'wrong' (expected: 'UQ2026')
```

### [SECURITY] - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–æ—Å—Ç—É–ø–∞

```
[SECURITY] User 123456 not verified, blocking access
```

### [MIGRATION] - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

```
[MIGRATION] Running database migrations...
[MIGRATION] Adding 'is_verified' column to users table...
[MIGRATION] ‚úÖ Migration completed: is_verified column added
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–¥–æ–º

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí `/start`
2. –ë–æ—Ç ‚Üí "üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "UQ2026"
4. –ë–æ—Ç ‚Üí "‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫"
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —è–∑—ã–∫
6. –ë–æ—Ç ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ò–Ω–≤–∞–π—Ç-–∫–æ–¥ –∑–∞–ø—Ä–æ—à–µ–Ω
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–Ω—è—Ç
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω —Å `is_verified=True`
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –æ—Ç–∫—Ä—ã—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–¥–æ–º

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí `/start`
2. –ë–æ—Ç ‚Üí "üîê –í–≤–µ–¥–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥"
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "wrong_code"
4. –ë–æ—Ç ‚Üí "‚ùå –ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
5. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "UQ2026"
6. –ë–æ—Ç ‚Üí "‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç!"

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–ª—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
- ‚úÖ –ú–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–Ω—è—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ù–æ–≤—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ê–¥–º–∏–Ω (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã admins) ‚Üí `/start`
2. –ë–æ—Ç ‚Üí "‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä! –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫"
3. –ê–¥–º–∏–Ω –≤—ã–±–∏—Ä–∞–µ—Ç —è–∑—ã–∫
4. –ë–æ—Ç ‚Üí –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ò–Ω–≤–∞–π—Ç-–∫–æ–¥ –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è
- ‚úÖ –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω —Å `is_verified=True`
- ‚úÖ –î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç —Å—Ä–∞–∑—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –ü–æ–ø—ã—Ç–∫–∞ –æ–±–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ù–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "üîç –°–ø—Ä–æ—Å–∏ –±–∞–∑—É"
2. Middleware ‚Üí –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å
3. –ë–æ—Ç ‚Üí "‚ö†Ô∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é (/start)"

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –•–µ–Ω–¥–ª–µ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 5: –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î

**–î–µ–π—Å—Ç–≤–∏—è:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ë–î
2. –ú–∏–≥—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
3. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
- ‚úÖ –ü–æ–ª–µ `is_verified` –¥–æ–±–∞–≤–ª–µ–Ω–æ
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: `is_verified=True`
- ‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### .env —Ñ–∞–π–ª

```env
# –ò–Ω–≤–∞–π—Ç-–∫–æ–¥ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INVITE_CODE=UQ2026

# –ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π
INVITE_CODE=YourSecretCode2026
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ `.env` —Ñ–∞–π–ª
2. –ò–∑–º–µ–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `INVITE_CODE`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
4. –ù–æ–≤—ã–π –∫–æ–¥ –≤—Å—Ç—É–ø–∏—Ç –≤ —Å–∏–ª—É

**–í–Ω–∏–º–∞–Ω–∏–µ:**
- –ö–æ–¥ case-sensitive: "UQ2026" ‚â† "uq2026"
- –ò–∑–±–µ–≥–∞–π—Ç–µ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –Ω–∞—á–∞–ª–µ/–∫–æ–Ω—Ü–µ
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –ß–µ—Ä–µ–∑ –ë–î

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
sqlite3 data/uqsoft.db

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT telegram_id, full_name, is_verified FROM users;

# –ù–∞–π—Ç–∏ –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
SELECT * FROM users WHERE is_verified = 0;

# –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤—Ä—É—á–Ω—É—é
UPDATE users SET is_verified = 1 WHERE telegram_id = 123456789;
```

### –ß–µ—Ä–µ–∑ –ª–æ–≥–∏

```bash
# –°–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
tail -f logs/bot.log | grep "\[INVITE\]"

# –°–º–æ—Ç—Ä–µ—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–æ—Å—Ç—É–ø–∞
tail -f logs/bot.log | grep "\[SECURITY\]"
```

## –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º

### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥—ã:**
   - –†–∞–∑–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–≤
   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –∫–æ–¥—ã
   - –ö–æ–¥—ã —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏

2. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –∫–æ–¥–æ–≤:**
   - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤
   - –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–¥–æ–≤

3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
   - –ö—Ç–æ –∏ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∫–æ–¥
   - –ò—Å—Ç–æ—Ä–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
   - –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤–≤–æ–¥–∞

4. **–ì–∏–±–∫–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - –û—Ç–∑—ã–≤ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
   - –í—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
   - –†–µ–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

## FAQ

**Q: –ß—Ç–æ –µ—Å–ª–∏ —è –∑–∞–±—ã–ª –∏–Ω–≤–∞–π—Ç-–∫–æ–¥?**  
A: –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û–Ω –º–æ–∂–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ "üîë –ò–Ω–≤–∞–π—Ç-–∫–æ–¥".

**Q: –ú–æ–≥—É—Ç –ª–∏ –∞–¥–º–∏–Ω—ã –æ–±—Ö–æ–¥–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É?**  
A: –î–∞, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã (–∏–∑ —Ç–∞–±–ª–∏—Ü—ã `admins`) –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –≤–≤–æ–¥–∞ –∫–æ–¥–∞.

**Q: –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏?**  
A: –û–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏. –î–æ—Å—Ç—É–ø –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω–≤–∞–π—Ç-–∫–æ–¥?**  
A: –î–∞, –≤ —Ñ–∞–π–ª–µ `.env` –∏–∑–º–µ–Ω–∏—Ç–µ `INVITE_CODE` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞.

**Q: –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –º–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥?**  
A: –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ, –Ω–æ –∫–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**Q: –ú–æ–∂–Ω–æ –ª–∏ –æ—Ç–æ–∑–≤–∞—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é?**  
A: –î–∞, —á–µ—Ä–µ–∑ SQL: `UPDATE users SET is_verified = 0 WHERE telegram_id = 123456789`

**Q: –ù—É–∂–Ω–∞ –ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î?**  
A: –ù–µ—Ç, –º–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.

## Rollback

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

### 1. –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥:

```bash
git revert HEAD
```

### 2. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ –∏–∑ –ë–î (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

```sql
-- SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç DROP COLUMN –Ω–∞–ø—Ä—è–º—É—é
-- –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –ø–æ–ª—è is_verified

-- –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
ALTER TABLE users RENAME TO users_backup;

-- –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ is_verified
CREATE TABLE users (...);  -- –ë–µ–∑ –ø–æ–ª—è is_verified

-- –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
INSERT INTO users SELECT ... FROM users_backup;  -- –ë–µ–∑ is_verified

-- –£–¥–∞–ª—è–µ–º backup
DROP TABLE users_backup;
```

**–ü—Ä–æ—â–µ:** –û—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ –ë–î, –æ–Ω–æ –Ω–µ –Ω–∞–≤—Ä–µ–¥–∏—Ç.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:

1. **app/core/models.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `is_verified` –≤ –º–æ–¥–µ–ª—å `User`

2. **app/utils/states.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `waiting_for_invite_code`

3. **app/bot/handlers/start.py**
   - –û–±–Ω–æ–≤–ª–µ–Ω —Ö–µ–Ω–¥–ª–µ—Ä `/start` - –∑–∞–ø—Ä–æ—Å –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞
   - –î–æ–±–∞–≤–ª–µ–Ω —Ö–µ–Ω–¥–ª–µ—Ä `handle_invite_code_input()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–æ–≤

4. **app/bot/middlewares/role.py**
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `is_verified`
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –Ω–µ–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

5. **app/core/database.py**
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤—ã–∑–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π –≤ `init_db()`

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:

1. **app/core/migrations.py**
   - –°–∏—Å—Ç–µ–º–∞ –º–∏–≥—Ä–∞—Ü–∏–π –ë–î
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ `is_verified`

2. **migrations/add_is_verified_field.sql**
   - SQL —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è)

## –ì–æ—Ç–æ–≤–æ! üîí

–°–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞:

‚úÖ –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç—Ä–µ–±—É—é—Ç –∏–Ω–≤–∞–π—Ç-–∫–æ–¥  
‚úÖ –ê–¥–º–∏–Ω—ã –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
‚úÖ Middleware –∑–∞—â–∏—â–∞–µ—Ç –≤—Å–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã  
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã  
‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
